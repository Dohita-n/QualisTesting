<div class="p-card mt-6">
    <p-table #dt1 [value]="users" [globalFilterFields]="['username', 'firstName', 'lastName', 'email']"
        selectionMode="single" dataKey="id" [tableStyle]="{ 'min-width': '50rem' }" [rows]="10" [paginator]="true"
        stateStorage="session" stateKey="users-table" [loading]="loading"
        (onRowSelect)="onRowSelect($event)" (onRowUnselect)="onRowUnselect()">

        <ng-template pTemplate="caption">
            <div class="flex justify-content-between align-items-center">
                <h5 class="m-0">Manage Users</h5>
                <span class="p-input-icon-left">
                    <i class="pi pi-search"></i>
                    <input pInputText type="text" (input)="onFilterInput($event)" placeholder="Search..." />
                </span>
            </div>
        </ng-template>

        <ng-template pTemplate="header">
            <tr>
                <th pSortableColumn="username" style="width:25%">
                    User <p-sortIcon field="username"></p-sortIcon>
                </th>
                <th pSortableColumn="status" style="width:15%">
                    Status <p-sortIcon field="status"></p-sortIcon>
                </th>
                <th style="width:40%">Profiles</th>
                <th style="width:10%">Actions</th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-user>
            <tr [pSelectableRow]="user" [attr.data-user-id]="user.id">
                <td>
                    <div class="flex items-center gap-2">
                        <p-avatar
                            [image]="user.avatarUrl || 'default-avatar.png'"
                            size="normal"
                            shape="circle"
                            [style]="{'width': '32px', 'height': '32px'}">
                        </p-avatar>
                        <div class="ml-1">
                            <div class="font-bold">{{ getUserFullName(user) }}</div>
                            <div class="text-sm text-gray-500">{{ user.email }}</div>
                        </div>
                    </div>
                </td>
                <td>
                    <p-tag [value]="user.status" [severity]="getSeverityStatus(user.status)"></p-tag>
                </td>
                <td>
                    <div class="flex flex-wrap gap-1">
                        <p-tag *ngFor="let profileName of getAllProfiles(user)" 
                               [value]="profileName" 
                               [severity]="getSeverityUserType(profileName)">
                        </p-tag>
                    </div>
                </td>
                <td>
                    <p-button icon="pi pi-cog" (click)="openProfileDialog(user)" [rounded]="true" [text]="true" pTooltip="Manage Profiles"></p-button>
                    <p-button icon="pi pi-trash" (click)="confirmDeleteUser(user, $event)" [rounded]="true" [text]="true" pTooltip="Delete User" class="ml-2"></p-button>
                </td>
            </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="4">No users found.</td>
            </tr>
        </ng-template>
    </p-table>
</div>

<!-- Profile Management Dialog -->
<p-dialog 
    [(visible)]="showProfileDialog" 
    [modal]="true" 
    [style]="{width: '500px', height: '600px'}" 
    [draggable]="false" 
    [resizable]="false"
    header="Manage User Profiles">
    
    <div *ngIf="selectedUser" class="p-fluid">
        <div class="user-info mb-4">
            <h3>{{ getUserFullName(selectedUser) }}</h3>
            <p class="text-sm text-gray-500">{{ selectedUser.email }}</p>
        </div>
        
        <div class="assigned-profiles-field">
            <label for="profiles">Assigned Profiles </label>
            <p-multiSelect 
                id="profiles" 
                [options]="availableProfiles" 
                [(ngModel)]="selectedProfiles" 
                optionLabel="name" 
                optionValue="id"
                placeholder="Select Profiles"
                [disabled]="loadingProfiles"
                [loading]="loadingProfiles"
                [filter]="true"
                display="chip">
            </p-multiSelect>
            
            <small class="block mt-2 text-gray-500">
                Users with multiple profiles will inherit all permissions from each profile.
            </small>
        </div>
    </div>
    
    <ng-template pTemplate="footer">
        <p-button 
            label="Cancel" 
            icon="pi pi-times" 
            (onClick)="closeProfileDialog()" 
            styleClass="p-button-text">
        </p-button>
        <p-button 
            label="Save Changes" 
            icon="pi pi-check" 
            (onClick)="saveProfileChanges()" 
            [disabled]="!selectedUser">
        </p-button>
    </ng-template>
</p-dialog>

<p-confirmDialog></p-confirmDialog>
<p-toast></p-toast>

